<!DOCTYPE html>
<html>
<head>
  <title>Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    .btn-success{
      background-color: #1cb891;
    }
    input{
      padding:4.5px 2px;
      border-radius: 5px;
    }
    .blank-card {
      height: 20vh;
      width: 100%;
      background-color: darkslategray;
      min-height: 140px;
    }

    .blank-card-mini {
      height: 20vh;
      width: 100%;
      background-color: darkslategray;
      min-height: 100px;
    }

    .admin-container{
      padding:20px 10px;
      box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px;
    }

    @media screen and (min-width:1200) {
      .blank-card {
        height: 20vh;
        width: 100%;
        background-color: darkslategray;
        min-height: 250px;
      }

      .blank-card-mini {
        height: 20vh;
        width: 100%;
        background-color: darkslategray;
        min-height: 230px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center align-items-center my-1 bg-lgreen py-3">
      <h4 class="text-center">Administrative Page for Game Control</h4>
    </div>
    <div class="row justify-content-center align-items-center">
      <div class="col-12 col-lg-8 admin-container"> 
        <div class="col-12 d-flex justify-content-center my-5">
          <button class="btn btn-dark px-4" onclick="JoinAdmin()">Join</button>
        </div>

        <div class="row justify-content-center align-items-center ms-5">
          <div class="form-group col-12 col-lg-8">
            <label class="form-label fw-bold me-2">Set Game Money</label>
            <input id="game-money" class="form-control" value="10000"/>
          </div>
        </div>
        <div class="form-check form-switch me-2 d-flex justify-content-center my-4">
          <input class="form-check-input" type="checkbox" role="switch" id="switchChecker">
          <label class="ms-4 form-check-label" for="switchChecker">Start Match with the Allocated Money</label>
        </div>
        

        <!--Section for Setting Money for Each Player Individually-->
        <div class="form-check form-switch me-2 d-flex justify-content-center my-4">
          <input class="form-check-input" type="checkbox" role="switch" id="switchCheckerForIndividualAllocation">
          <label class="ms-4 form-check-label" for="switchChecker">Set Money for each individual player</label>
        </div>
        <!--Admin Panel for setting individual money-->
        <div class="row justify-content-center align-items-center my-1 py-3">
          <div class="form-group col-12 col-md-6">
            <div id="money-setter-cont"></div>            
            <!-- <div class="row justify-content-center align-items-center">
                <button class="col-12 btn btn-primary px-4 mt-5" onclick="DeclareWinner()">Set Money for Individual Player</button>
            </div> -->
          </div>
        </div>
        <!--End Admin Panel for setting individual money-->
        <!--End of Section for Setting Money for Each Player Individually-->


        <div class="row justify-content-center align-items-center my-1 py-3">
          
            <button id="start-match" class="col-3 btn btn-success px-4 me-4" onclick="StartMatch()">Start Match</button>  
            <button class="col-3 btn btn-danger px-4" onclick="ResetDb()">Reset Game</button>
        </div>
        <div class="row justify-content-center align-items-center my-1 py-4">
          <button class="col-3 btn btn-info px-4 me-4" onclick="ShowOneOfTheCards()">Display Card</button>
          <button class="col-3 btn btn-primary px-4" onclick="RevealAllCards()">Reveal All Player's Card</button>
        </div>


        <div class="row justify-content-center align-items-center my-1 py-3">
          <div class="form-group col-12 col-md-6">
            <label>Select the Winner</label>
            <select class="form-select" id="winner-selectlist">
              <option value="">-- Select -- </option>
            </select>
            <div class="row justify-content-center align-items-center">
                <button class="col-12 btn btn-warning px-4 mt-5" onclick="DeclareWinner()">Declare Winner</button>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="../public/cardmaster.js"></script>

  <script>
    var countOfItemsToDisplay=0;
    $("#start-match").show();
    const socket = io();
    
    
    socket.on("connect", () => {
      window.sessionStorage.setItem("socket-id",socket.id);
    });

    //====Join on the room based on page load
    // if (window.localStorage.getItem("myname") == undefined) {
    //   window.localStorage.setItem("myname", "Administrator");      
    // }

    const JoinAdmin= ()=>{
      socket.emit('join', "Administrator",window.sessionStorage.getItem("socket-id"));
    }

    //====Reset table to default state    
    const ResetDb = ()=>{
      let sign = prompt(`Do you want to Reset Game to Initial state?. Type 'yes' or y to continue`);
      if(sign != null){
        if(sign.toLowerCase()== "yes" || sign.toLowerCase()=="y"){
          $("#winner-selectlist").html(`<option value="">-- Select -- </option>`);
          socket.emit('reset_db_admn', "Administrator");
        }
      }
      
    }

    //==== Show Cards from everyone
    const RevealAllCards=()=>{
      let sign = prompt(`Do you want to Reveal every player's Card ?. Type 'yes' or y to continue`);
      if(sign != null){
        if(sign.toLowerCase()== "yes" || sign.toLowerCase()=="y"){
          socket.emit('reveal_all_cards', "Administrator");
        }
      }
    }

    //======Start the Match
    const StartMatch = () => {
      let isIndividualAllocationchecked=$("#switchCheckerForIndividualAllocation").is(":checked")?true:false;
      let isGroupAllocationchecked=$("#switchChecker").is(":checked")?true:false;
      //console.log(isIndividualAllocationchecked,isGroupAllocationchecked);
      if(isGroupAllocationchecked || isIndividualAllocationchecked){

        let amountToBeGiven= $("#switchChecker").is(":checked")?$("#game-money").val():0;
        let sign = prompt(`Do you want to start the game ? Type 'yes' or y to continue`);
        if(sign != null){
          if(sign.toLowerCase()== "yes" || sign.toLowerCase()=="y"){
            socket.emit('start_game_admn',amountToBeGiven);        
          }
        }      
        window.localStorage.setItem("show_card",0);
        
      }
      else{
        alert ("please check at least one of the slider");
        return;
      }
      
      
      return;
    }
   

    //======Declare Winnder
    const DeclareWinner = () => {
      let winner=$("#winner-selectlist").val();
      let sign = prompt(`Do you want to Declare ${winner} as the Winner of this match? Type 'yes' or y to continue`);
      if(sign != null){
        if(sign.toLowerCase()== "yes" || sign.toLowerCase()=="y"){
          socket.emit('declare_winner',winner);          
        }
      }      
      window.localStorage.setItem("show_card",0);
      return;
    }
   


    //=== Show Cards
    const ShowOneOfTheCards = () => {
      console.log("show cards");
      const allCards = ["card-5", "card-4", "card-3", "card-2", "card-1"];
      if(window.localStorage.getItem("show_card")!=undefined){
        let lastDisplayedCard=parseInt(window.localStorage.getItem("show_card"));
        if (confirm(`Show the Card-${lastDisplayedCard+1} ?`)) {
          socket.emit("display-card", allCards[lastDisplayedCard]);
          
          if(lastDisplayedCard < allCards.length-1){
            lastDisplayedCard++;
            window.localStorage.setItem("show_card",lastDisplayedCard);
            return;
          }
        }        
      }      
    }

    //===Set the money of individual player
    const RenderPlayerMoneySection = async (playerList)=>{
      let initialContent=$("#money-setter-cont").html();
      playerList.forEach(player=>{
        initialContent += `<label>Set money of Player <span id="">${player.name}</span></label>
        <input id="money-${player.name}" class="form-control"/>`
      });
      $("#money-setter-cont").html(initialContent);
    }
    const SetPlayerIndividualMoney = async(playerList)=>{
        let arryofSettedPlayerMoney= [];
        await playerList.forEach(player=>{
          let playerMoney = parseInt($(`#money-${player.name}`).val());
          if(isNaN(playerMoney)){
            return [];
          }          
          arryofSettedPlayerMoney.push({name:`${player.name}`,amount:playerMoney});         
              
        });
        return arryofSettedPlayerMoney;
    }

    const FinallyStartMatch = async ()=>{
      let playerList= await JSON.parse(window.localStorage.getItem("playerList"));
      let moneyArry= await SetPlayerIndividualMoney(playerList);
      console.log(moneyArry);
      //moneyArry = JSON.parse(window.localStorage.getItem("moneyArry"));
      //console.log(moneyArry);
      if(moneyArry != []){
        socket.emit("set-individual-player-money",moneyArry,"Administrator");
      }      
    }
    
    const SetMoneyForEachPlayer = async (playerList)=>{

      if(!$("#switchChecker").is(":checked")){
        $("#start-match").hide();
        await RenderPlayerMoneySection(playerList);

        //===now render the action button for setting individual player money
        let htmlContent = $("#money-setter-cont").html();
        htmlContent+=`<button class="col-12 btn btn-primary px-4 mt-5" onclick="FinallyStartMatch()">Set Each Player Money & Start Match</button>`
        $("#money-setter-cont").html(htmlContent);
        await window.localStorage.setItem("playerList",JSON.stringify(playerList));
      }
      else{
        socket.emit("start-directly",playerCardInfo,"Administrator");
      }
      
    }
       

    socket.on('ready_to_start_game', async function (playerCardInfo) {
      console.log("Ready to Start Game");
      //switchCheckerForIndividualAllocation
      let shouldStartDirectly= $("#switchCheckerForIndividualAllocation").is(":checked")?false:true;
      //=== based on checking if the box is at default state which means we should not allocated money send the event
      //=== to admin to start the game otherwise set money for each player and then start the match.

      if(shouldStartDirectly){
        $('#switchCheckerForIndividualAllocation').attr('checked',false);
        console.log("start directly");
        socket.emit("start-directly",playerCardInfo,"Administrator");
      }
      else{
        console.log("else logic");
        $("#game-money").prop("readonly", true);
        await SetMoneyForEachPlayer(playerCardInfo);
      }
      
    });

    //=== Show or hide individual money container based on user's toggle.
    $("#switchCheckerForIndividualAllocation").change(()=>{
      
      let ischecked=$("#switchCheckerForIndividualAllocation").is(":checked")?true:false;
      console.log(ischecked)
      if(ischecked){
        $("#money-setter-cont").show();
      }
      else{
        $("#money-setter-cont").hide();
      }
    })

    socket.on('player_joined', function (user) {
      console.log("player joined");
      alert(`Congratulation !! ${user} joined`);
    });

    socket.on('start_game', function (playerCardInfo) {
      $("#winner-selectlist").html(`<option value="">-- Select -- </option>`);
      let tempString=$("#winner-selectlist").html();
      playerCardInfo.forEach(elm => {
        tempString+=`<option value="${elm.name}">${elm.name}</option>`;        
      });
      $("#winner-selectlist").html(tempString);
    });

  </script>
</body>

</html>