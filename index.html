<!DOCTYPE html>
<html>

<head>
  <title>Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    .blank-card {
      height: 20vh;
      width: 100%;
      background-color: darkslategray;
      min-height: 140px;
    }

    .blank-card-mini {
      height: 20vh;
      width: 100%;
      background-color: darkslategray;
      min-height: 110px;
    }

    .info-box {
      padding: 3px 2px;
      color: darkblue;
      font-weight: 600;
    }

    .player-info {
      padding: 10px 2px;
      font-weight: 600;
    }

    .money {
      background: #2dfcc0;
      padding: 2px 5px;
      border-radius: 20px;
    }

    .amount {
      background: royalblue;
      color: yellow;
      padding: 2px 5px;
      border-radius: 20px;
    }

    .amount-total {
      background: rgb(255, 255, 255);
      color: rgb(190, 14, 117);
      padding: 2px 5px;
      border-radius: 20px;
    }

    .total-played {
      font-weight: 900;
      font-size: 1.25rem;
    }


    @media screen and (min-width: 900px) {
      .blank-card {
        height: 40vh;
        width: 100%;
        background-color: darkslategray;
        min-height: 250px;
      }

      .blank-card-mini {
        height: 20vh;
        width: 100%;
        background-color: darkslategray;
        min-height: 210px;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <!-- <button onclick="FunctionRunOnPageRefresh()" class="btn btn-warning px-2">Resync()</button> -->
    <!-- Join with Name-->
    <div class="col-12 row justify-content-center align-items-center mt-2">
      <div class="my-3 row col-6" id="join-cont">
        <label for="inputPassword" class="col-sm-6 col-form-label">Enter your name</label>
        <div class="col-sm-6">
          <input type="text" class="form-control" id="username">
        </div>
      </div>
      <div class="col-sm-2" id="join-btn"><button class="btn btn-info px-4" onclick="Join()">Join</button></div>
    </div>
    <!-- End Join with Name-->

    <!--Card Section-->
    <div class="col-12 row justify-content-center align-items-center mt-5">
      <div class="pokcard col-2 my-2" id="card-1" onclick="ShowBoardCard(4)">
        <div class="blank-card"></div>
      </div>
      <div class="pokcard col-2 my-2" id="card-2" onclick="ShowBoardCard(3)">
        <div class="blank-card"></div>

      </div>
      <div class="pokcard col-2 my-2" id="card-3" onclick="ShowBoardCard(2)">
        <div class="blank-card"></div>

      </div>
      <div class="pokcard col-2 my-2" id="card-4" onclick="ShowBoardCard(1)">
        <div class="blank-card"></div>
      </div>
      <div class="pokcard col-2 my-2" id="card-5" onclick="ShowBoardCard(0)">
        <div class="blank-card"></div>
      </div>
    </div>
    <!--End Card Section-->

    <!--Start Action Section-->
    <div class="row justify-content-center align-items-center mt-4" id="important-buttons-cont">

      <div class="d-flex justify-content-center align-items-center mt-4 col-2">
        <button class="btn btn-primary px-4" onclick="SendGameEvent('Check')">Check</button>
      </div>

      <div class="d-flex justify-content-center align-items-center mt-4 col-3">
        <div class="col-8">
          <input id="raised-amount" class="form-control" />
        </div>
        <button class="btn btn-info px-4" onclick="SendGameEvent('Raise')">Raise</button>
      </div>
      <div class="d-flex justify-content-center align-items-center mt-4 col-2">
        <button class="btn btn-danger px-4" onclick="SendGameEvent('Fold')">Fold</button>
      </div>
      <div class="d-flex justify-content-center align-items-center mt-4 col-2">
        <button class="btn btn-dark px-4" onclick="SendGameEvent('All_In')">All In</button>
      </div>
      <div class="d-flex justify-content-center align-items-center mt-4 col-2">
        <button class="btn btn-warning px-4" onclick="SendGameEvent('Match')">Match</button>
      </div>
    </div>
    <!--End Action Section-->

    <!--Start Others Player Section-->
    <div class="row justify-content-center align-items-center mt-4" id="cards-displaypanel"></div>
    <!--End Others Player Section-->
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="../public/cardmaster.js"></script>
  <script>


    const RenderDeckGame = (myName, singlePlayerInfo) => {
      $(`#p${singlePlayerInfo.userIndex}-name`).text(singlePlayerInfo.name);
      $(`#p${singlePlayerInfo.userIndex}-money`).text(singlePlayerInfo.money);
      $(`#p${singlePlayerInfo.userIndex}-given`).text(singlePlayerInfo.playedTotalSoFar);

      if (singlePlayerInfo.name == myName) {
        window.sessionStorage.setItem("myUserIndex", singlePlayerInfo.userIndex);
        $(`#p${singlePlayerInfo.userIndex}-cont`).css({
          "background-color": "#f7d9fc",
          "padding": "20px 5px",
          "margin": "5px"
        });
      }
    }


    const FunctionRunOnPageRefresh = () => {
      console.log("function on pageRefresh");
      let gameOverallInfos = JSON.parse(window.sessionStorage.getItem("gameinfo"));
      let myName = window.sessionStorage.getItem("myname");
      gameOverallInfos.forEach(x => {
        RenderCardDisplayPanel(x.userIndex);
        RenderDeckGame(myName, x);
      });

      //===Now User his own card
      let cardsIReceived = JSON.parse(window.sessionStorage.getItem("receivedCards"));
      $(`#p${window.sessionStorage.getItem("myUserIndex")}-firstCard`).html(`<card-t rank=${cardsIReceived[0][0]} suit=${cardsIReceived[0][1]}></card-t>`);
      $(`#p${window.sessionStorage.getItem("myUserIndex")}-secondCard`).html(`<card-t rank=${cardsIReceived[1][0]} suit=${cardsIReceived[1][1]}></card-t>`);

    }

    const ResyncMyInformations = () => {
      if (window.sessionStorage.getItem("gameinfo") != undefined && window.sessionStorage.getItem("receivedCards") != undefined) {
        if (window.sessionStorage.getItem("isgameStarted") != undefined && window.sessionStorage.getItem("isgameStarted") == true) {
          FunctionRunOnPageRefresh();
        }
      }
    }

    //var runnyingRound = 1;
    var cardsIReceived = []; //used for accepting and then transfering values to session storage
    const socket = io();

    socket.on("connect", () => {
      window.sessionStorage.setItem("socket-id", socket.id);
    });


    //===Default Function for the user to connect to the room
    //===On page refresh

    // if (window.sessionStorage.getItem("myname") != undefined) {
    //   $("#join-cont,#join-btn").hide();
    //   socket.emit('join', window.sessionStorage.getItem("myname"));      
    // }

    const ShowBoardCard =(cardIndex)=>{
      const allCards = ["card-5", "card-4", "card-3", "card-2", "card-1"];
      socket.emit("show_board_card",allCards[cardIndex]);
    } 


    const Join = () => {
      let username = $("#username").val();
      if (username.length > 0) {
        window.sessionStorage.setItem("myname", username);
        socket.emit('join', username, window.sessionStorage.getItem("socket-id"));
      }
      $("#join-cont,#join-btn").hide();
    }

    //===Server sends response with the player's own card
    socket.on("your_card_is",function(myOwnCard){
      cardsIReceived=myOwnCard;
    })

    //====If the card is not revealed for this user then after event server sends the hidden card info
    socket.on("board-card-revealed",function([d,card,group]){
      $("#" + d).html(`<card-t rank=${card} suit=${group}></card-t>`);
    })

    //==Show the winner of the match
    socket.on('winner_declared', function (winner) {
      alert(`The winner of the match is ${winner}.`);
    });

    socket.on('mynewcards', function (myCards, cardUser) {
      console.log("event executed");
      alert("I Received my card");
      if (window.sessionStorage.getItem("myname") == cardUser) {
        cardsIReceived = myCards;
      }
    })

    //===Reveal the board card one at a time for every player

    socket.on('card-reveal', function (d, card, group) {
      //alert("card revealed");
      console.log(d, card, group);
      $("#" + d).html(`<card-t rank=${card} suit=${group}></card-t>`);
    });

    //====Event after player joined in the match

    socket.on('player_joined', function (user) {
      alert(`Player ${user} joined`);
    });


    socket.on('show_everyones_cards', function (arry) {
      arry.forEach(x => {
        $(`#p${x.index}-firstCard`).html(`<card-t rank=${x.cards[0][0]} suit=${x.cards[0][1]}></card-t>`);
        $(`#p${x.index}-secondCard`).html(`<card-t rank=${x.cards[1][0]} suit=${x.cards[1][1]}></card-t>`);
      });
    });


    //====Excetution Event

    socket.on('executed_event', function (gameInfoArry, playerWhoPlayed) {
      console.log(gameInfoArry, playerWhoPlayed);
      let myName = window.sessionStorage.getItem("myname");
      window.sessionStorage.setItem("gameInfoArry", JSON.stringify(gameInfoArry));
      gameInfoArry.forEach(x => {
        $(`#p${x.userIndex}-name`).text(x.name);
        $(`#p${x.userIndex}-money`).text(x.money);
        $(`#p${x.userIndex}-given`).text(x.playedThisRound);
        $(`#p${x.userIndex}-givenTotal`).text(x.playedTotalSoFar);
        $(`#p${x.userIndex}-state`).text(x.currentState);

        if (x.name == myName) {
          //window.sessionStorage.setItem("selfCardId", x.userIndex);
          $(`#p${x.userIndex}-cont`).css({
            "background-color": "#f7d9fc",
            "padding": "20px 5px",
            "margin": "5px"
          })
        }
        else if (x.name == playerWhoPlayed) {

          $(`#p${x.userIndex}-cont`).css({
            "background-color": "#f1ffa8",
            "padding": "10px 5px",
            "margin": "5px"
          });
        }
        else {

          $(`#p${x.userIndex}-cont`).css({
            "background-color": "#fff",
            "padding": "10px 5px",
            "margin": "5px"
          });
        }
      });
    });


    //====Start Match after Admin Request
    socket.on('start_game', function (playerCardInfo) {
      $("#important-buttons-cont").show();
      window.sessionStorage.setItem("isgameStarted", true);
      //console.log(playerCardInfo);
      $(".pokcard").html(`<div class="blank-card"></div>`);
      let myName = '';
      if (window.sessionStorage.getItem("myname") != undefined) {
        myName = window.sessionStorage.getItem("myname");
        window.sessionStorage.clear();
        window.sessionStorage.setItem("myname", myName);
        $("#join-cont,#join-btn").hide();
      }

      $("#cards-displaypanel").html("");
      alert('Match Started');

      playerCardInfo = playerCardInfo.filter(x => {
        return x.name != "Administrator";
      });

      window.sessionStorage.setItem("gameinfo", JSON.stringify(playerCardInfo));
      console.log(playerCardInfo);

      for (let i = 0; i < playerCardInfo.length; i++) {
        RenderCardDisplayPanel(playerCardInfo[i].userIndex);
        RenderDeckGame(myName, playerCardInfo[i]);
        if (playerCardInfo[i].name == myName) {
          window.sessionStorage.setItem("selfCardId", i);
        }
      }

      console.log(cardsIReceived);
      if (cardsIReceived.length > 0) {
        window.sessionStorage.setItem("receivedCards", JSON.stringify(cardsIReceived));
        $(`#p${window.sessionStorage.getItem("myUserIndex")}-firstCard`).html(`<card-t rank=${cardsIReceived[0][0]} suit=${cardsIReceived[0][1]}></card-t>`);
        $(`#p${window.sessionStorage.getItem("myUserIndex")}-secondCard`).html(`<card-t rank=${cardsIReceived[1][0]} suit=${cardsIReceived[1][1]}></card-t>`);
      }
      else {
        socket.emit('show_my_card', myName);        
      }
    });

    const SendGameEvent = (type) => {
      let gameOverviewInfos = JSON.parse(window.sessionStorage.getItem("gameInfoArry"));
      if (window.sessionStorage.getItem("myname") != undefined) {
        let username = window.sessionStorage.getItem("myname");

        if (type == "Check") {
          socket.emit('game_event', 'Check', username, "0");
        }
        else if (type == "Fold") {
          socket.emit('game_event', 'Fold', username, "0");
          $("#important-buttons-cont").hide();
        }
        else if (type == "Raise" || type == "All_In") {
          let raisedMoney = $('#raised-amount').val();

          if (type == "Raise") {
            //$(`#p${userCardId}-given`).text(`Amount Played:${raisedMoney}`);
            //$(`#p${userCardId}-money`).text(availableCash);
            socket.emit('game_event', 'Raise', username, raisedMoney.toString());
            
            // let myMoney = gameOverviewInfos[parseInt(window.sessionStorage.getItem("selfCardId"))].money;
            // if(raisedMoney>myMoney){
            //   alert("You can't raise money higher than your balance.")
            // }
            // else{
            //   socket.emit('game_event', 'Raise', username, raisedMoney.toString());
            // }
            
            $('#raised-amount').val("");
          }
          else if (type == "All_In") {
            //$(`#p${userCardId}-given`).text(`Amount Played:${tempDetails[0].money}`);
            //$(`#p${userCardId}-money`).text(0);
            socket.emit('game_event', 'All_In', username, "");
            $("#important-buttons-cont").hide();
          }
        }

        else if (type == "Match") {
          
          let higestAmount = [0,0];
          gameOverviewInfos.forEach(x => {
            console.log(x.playedThisRound)
            if (parseInt(x.playedThisRound) > higestAmount[0]) {
              higestAmount[0] = x.playedThisRound;
            }
            if (x.name == username) {
              higestAmount[1] = x.playedThisRound;
            }
          });
          let matchAmount = higestAmount[0] - higestAmount[1];
          socket.emit('game_event', 'Raise', username, matchAmount.toString());
        }

      }

    }


    const RenderCardDisplayPanel = (userId) => {
      let htmlSTring = `<div class="mt-4 col-2" id="p${userId}-cont">
        <div class="d-flex">
          <div class="col-6 px-1 own-card" id="p${userId}-firstCard">
            <div class="blank-card-mini"></div>
          </div>
          <div class="col-6 px-1 own-card" id="p${userId}-secondCard">
            <div class="blank-card-mini"></div>
          </div>
        </div>
        <div class="col-12">
          <div class="player-info text-center" id="p${userId}-name">Player-${userId}</div>
          <div class="info-box">
            <h6 class="mx-2 text-center" id="p${userId}-state">Not Started</h6>
            <h6 class="mx-2 amount-total text-center">Total Amount Played in this match: <span class="total-played" id="p${userId}-givenTotal">0</span>Tk</h6>
            <h6 class="mx-2 amount text-center">Amount Played: <span id="p${userId}-given">0</span>Tk</h6>
            <h6 class="mx-2 money text-center">Total: <span id="p${userId}-money">0</span>Tk</h6>
          </div>
        </div>
      </div>`
      let string = $("#cards-displaypanel").html();
      htmlSTring = string + htmlSTring;
      $("#cards-displaypanel").html(htmlSTring);
    }
  </script>
</body>

</html>